(()=>{"use strict";const e=window.crypto||window.msCrypto,t=window.localStorage,n="hexo-blog-encrypt:#"+window.location.pathname,o=y("hexo-blog-encrypt的作者们都是大帅比!"),r=y("hexo-blog-encrypt是地表最强Hexo加密插件!"),a=document.getElementById("hexo-blog-encrypt"),i=a.dataset.wpm,s=a.dataset.whm,c=a.getElementsByTagName("script").hbeData,l=c.innerText,u=c.dataset.hmacdigest;function d(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map(e=>parseInt(e,16)))}function y(e){for(var t=e.length,n=0,o=new Array,r=0;r<t;){var a=e.codePointAt(r);a<128?(o[n++]=a,r++):a>127&&a<2048?(o[n++]=a>>6|192,o[n++]=63&a|128,r++):a>2047&&a<65536?(o[n++]=a>>12|224,o[n++]=a>>6&63|128,o[n++]=63&a|128,r++):(o[n++]=a>>18|240,o[n++]=a>>12&63|128,o[n++]=a>>6&63|128,o[n++]=63&a|128,r+=2)}return new Uint8Array(o)}function m(e){if("object"!=typeof e||null===e||"number"!=typeof e.byteLength)throw new TypeError("Expected input to be an ArrayBuffer");for(var t,n=new Uint8Array(e),o="",r=0;r<n.length;r++)o+=1===(t=n[r].toString(16)).length?"0"+t:t;return o}async function h(e){let t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("script").forEach(async e=>{e.replaceWith(await async function(e){let t=document.createElement("script");return["type","text","src","crossorigin","defer","referrerpolicy"].forEach(n=>{e[n]&&(t[n]=e[n])}),t}(e))}),t}function f(t){let n=new TextEncoder;return e.subtle.importKey("raw",n.encode(t),{name:"PBKDF2"},!1,["deriveKey","deriveBits"])}function g(t){return e.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:o.buffer,iterations:1024},t,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"])}function p(t){return e.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:o.buffer,iterations:1024},t,{name:"AES-CBC",length:256},!0,["decrypt"])}function w(t){return e.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:r.buffer,iterations:512},t,128)}async function b(t,o,r){let a=d(l);return await e.subtle.decrypt({name:"AES-CBC",iv:o},t,a.buffer).then(async t=>{const o=(new TextDecoder).decode(t);if(!o.startsWith("<hbe-prefix></hbe-prefix>"))throw"Decode successfully but not start with KnownPrefix.";const a=document.createElement("button");a.textContent="Encrypt again",a.type="button",a.classList.add("hbe-button"),a.addEventListener("click",()=>{window.localStorage.removeItem(n),window.location.reload()}),document.getElementById("hexo-blog-encrypt").style.display="inline",document.getElementById("hexo-blog-encrypt").innerHTML="",document.getElementById("hexo-blog-encrypt").appendChild(await h(o)),document.getElementById("hexo-blog-encrypt").appendChild(a),document.querySelectorAll("img").forEach(e=>{e.getAttribute("data-src")&&!e.src&&(e.src=e.getAttribute("data-src"))}),window.NexT&&NexT.boot&&"function"==typeof NexT.boot.refresh&&NexT.boot.refresh();var i=document.getElementById("toc-div");i&&(i.style.display="inline");var c=document.getElementsByClassName("toc-div-class");if(c&&c.length>0)for(var l=0;l<c.length;l++)c[l].style.display="inline";var y=new Event("hexo-blog-decrypt");return window.dispatchEvent(y),await async function(t,n){const o=(new TextEncoder).encode(n);let r=d(u);const a=await e.subtle.verify({name:"HMAC",hash:"SHA-256"},t,r,o);return console.log(`Verification result: ${a}`),a||(alert(s),console.log(`${s}, got `,r," but proved wrong.")),a}(r,o)}).catch(e=>(alert(i),console.log(e),!1))}!function(){const o=JSON.parse(t.getItem(n));if(o){console.log(`Password got from localStorage(${n}): `,o);const i=d(o.iv).buffer,s=o.dk,c=o.hmk;e.subtle.importKey("jwk",s,{name:"AES-CBC",length:256},!0,["decrypt"]).then(o=>{e.subtle.importKey("jwk",c,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]).then(e=>{b(o,i,e).then(e=>{e||t.removeItem(n)})})})}const r=document.getElementById("hbePass");if(r){const l=document.createElement("button");l.textContent="提交密码",l.type="button",l.className="hbe-button",l.style.cssText="margin-top: 10px; width: 60%; text-align: center; text-indent: 0;";const u=r.closest(".hbe-input");function y(e){return e.trim().replace(/\s+/g,"")}async function h(o){try{if(console.log("开始处理密码"),o=y(o),console.log("处理后的密码长度:",o.length),!e||!e.subtle)return alert("您的浏览器不支持Web Crypto API，请尝试更新浏览器"),!1;const r=await f(o),[a,i,s]=await Promise.all([g(r),p(r),w(r)]);console.log("密钥生成成功，开始解密");const c=new Promise((e,t)=>{setTimeout(()=>t(new Error("解密操作超时")),1e4)}),l=b(i,s,a),u=await Promise.race([l,c]);if(console.log(`解密结果: ${u}`),u){const[o,r]=await Promise.all([e.subtle.exportKey("jwk",i),e.subtle.exportKey("jwk",a)]),c={dk:o,iv:m(s),hmk:r};return t.setItem(n,JSON.stringify(c)),!0}return!1}catch(e){return console.error("解密过程出错:",e),alert("解密失败: "+(e.message||"未知错误")),!1}}u&&u.insertAdjacentElement("afterend",l),l.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault(),l.textContent="处理中...",l.disabled=!0,setTimeout(async function(){const e=document.getElementById("hbePass").value;await h(e)||(l.textContent="提交密码",l.disabled=!1)},100)}),l.addEventListener("touchend",function(e){e.preventDefault(),this.click()}),r.addEventListener("input",function(){const e=this.value.replace(/[\u200B-\u200D\uFEFF]/g,"");e!==this.value&&(this.value=e)})}a.addEventListener("keydown",async o=>{if(o.isComposing||13===o.keyCode){const o=document.getElementById("hbePass").value,r=await f(o),a=await g(r),i=await p(r),s=await w(r);b(i,s,a).then(o=>{console.log(`Decrypt result: ${o}`),o&&e.subtle.exportKey("jwk",i).then(o=>{e.subtle.exportKey("jwk",a).then(e=>{const r={dk:o,iv:m(s),hmk:e};t.setItem(n,JSON.stringify(r))})})})}})}()})();